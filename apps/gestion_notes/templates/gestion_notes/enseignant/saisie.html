{% extends 'gestion_notes/base_notes.html' %}
{% load static %}
{% block title %}Saisie des Notes{% endblock %}
{% block main_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h2 fw-bold" style="color:var(--primary-color);"><i class="bi bi-clipboard-check me-2"></i>Saisie des Notes</h1>
        <p class="text-muted mb-0">Enseignant : {{ enseignant.get_full_name }}</p>
    </div>
</div>

<!-- Filtres avec Année -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <!-- NOUVEAU : Dropdown Année -->
            <div class="col-md-4">
                <label class="form-label fw-bold">Année Académique :</label>
                <select name="annee" class="form-select" onchange="this.form.submit()">
                    {% for annee in annees %}
                        <option value="{{ annee.pk }}" {% if annee_selectionnee and annee.pk == annee_selectionnee.pk %}selected{% endif %}>
                            {{ annee.annee }} {% if annee.est_active %}★{% endif %}
                        </option>
                    {% endfor %}
                </select>
                <small class="text-muted">
                    {% if annee_selectionnee.est_active %}
                        ★ Année active - Tous les étudiants
                    {% else %}
                        Année précédente - Étudiants en dette uniquement
                    {% endif %}
                </small>
            </div>

            <!-- Matière -->
            <div class="col-md-8">
                <label class="form-label fw-bold">Choisir une matière :</label>
                <select name="matiere" class="form-select" onchange="this.form.submit()">
                    <option value="">-- Choisir une matière --</option>
                    {% for mat in matieres %}
                        <option value="{{ mat.id }}" {% if matiere_selectionnee and mat.id == matiere_selectionnee.id %}selected{% endif %}>
                            {{ mat.code }} - {{ mat.nom }} ({{ mat.niveau.code }} {{ mat.semestre.code }})
                        </option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>
</div>

{% if matiere_selectionnee %}
<!-- Tableau saisie notes -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-book me-2"></i>{{ matiere_selectionnee.code }} - {{ matiere_selectionnee.nom }}</span>
        <a href="{% url 'gestion_notes:saisie_soumettre' matiere_selectionnee.id %}" class="btn btn-success btn-sm">
            <i class="bi bi-send me-1"></i>Soumettre Toutes les Notes
        </a>
    </div>
    <div class="card-body p-0 table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Étudiant</th>
                    <th>Matricule</th>
                    <th style="width:100px;">Note 1 (×0.3)</th>
                    <th style="width:100px;">Note 2 (×0.3)</th>
                    <th style="width:100px;">Note 3 (×0.4)</th>
                    <th style="width:80px;">Moyenne</th>
                    <th>Statut</th>
                    <th class="text-center">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for item in notes_data %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td><strong>{{ item.etudiant.get_full_name }}</strong></td>
                    <td>{{ item.etudiant.matricule }}</td>

                    {% if item.peut_modifier %}
                    <!-- Formulaire editable -->
                    <form method="post" action="{% url 'gestion_notes:saisie_sauvegarder' item.note.id %}" style="display:contents;">
                        {% csrf_token %}
                        <td>{{ item.form.note1 }}</td>
                        <td>{{ item.form.note2 }}</td>
                        <td>{{ item.form.note3 }}</td>
                        <td class="text-center"><strong>{{ item.note.moyenne }}</strong></td>
                        <td>
                            {% if item.note.statut == 'brouillon' %}
                                <span class="badge bg-secondary">Brouillon</span>
                            {% elif item.note.statut == 'invalide' %}
                                <span class="badge bg-danger">Invalidé</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <!-- MODIFICATION ICI : 2 boutons au lieu d'un seul -->
                            <button type="submit" name="action" value="save" class="btn btn-sm btn-secondary me-1" title="Sauvegarder en brouillon">
                                <i class="bi bi-floppy"></i>
                            </button>
                            <button type="submit" name="action" value="submit" class="btn btn-sm btn-success" title="Soumettre au chef">
                                <i class="bi bi-send"></i>
                            </button>
                        </td>
                    </form>
                    {% else %}
                    <!-- Lecture seule -->
                        <td class="text-center">{{ item.note.note1|default:"—" }}</td>
                        <td class="text-center">{{ item.note.note2|default:"—" }}</td>
                        <td class="text-center">{{ item.note.note3|default:"—" }}</td>
                        <td class="text-center"><strong>{{ item.note.moyenne }}</strong></td>
                        <td>
                            {% if item.note.statut == 'soumis' %}
                                <span class="badge bg-warning text-dark">Soumis</span>
                            {% elif item.note.statut == 'valide' %}
                                <span class="badge bg-success">Validé</span>
                            {% endif %}
                        </td>
                        <td class="text-center text-muted">—</td>
                    {% endif %}
                </tr>
                {% empty %}
                <tr><td colspan="9" class="text-center py-4 text-muted">
                    {% if annee_selectionnee.est_active %}
                        Aucun étudiant trouvé pour cette matière
                    {% else %}
                        Aucun étudiant en dette pour cette matière
                    {% endif %}
                </td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Explication calcul -->
<div class="card mt-3">
    <div class="card-body">
        <small class="text-muted">
            <strong>Calcul Moyenne :</strong> Note1 × 0.3 + Note2 × 0.3 + Note3 × 0.4 | 
            <strong>Résultat :</strong> ≥5 = Admis | ≥3 = Session | &lt;3 = Dette | Notes sur 10
        </small>
    </div>
</div>

<!-- Info année précédente -->
{% if not annee_selectionnee.est_active %}
<div class="alert alert-warning mt-3">
    <i class="bi bi-info-circle me-2"></i>
    <strong>Année précédente :</strong> Vous ne voyez que les étudiants ayant des notes non validées (rattrapages).
    Une fois validées par le chef, ces notes permettront aux étudiants de réussir leur année {{ annee_selectionnee.annee }}.
</div>
{% endif %}

{% else %}
<!-- Pas de matière sélectionnée -->
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-arrow-up" style="font-size:3rem;color:var(--primary-color);"></i>
        <h5 class="mt-3">Choisissez une matière ci-dessus</h5>
        <p class="text-muted">pour commencer la saisie des notes</p>
    </div>
</div>
{% endif %}
{% endblock %}